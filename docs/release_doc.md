# Release documentation

## preparation

Create virtual env:

```
python3 -m venv .venv
source .venv/bin/activate
pip install -r release-requirements.txt
```


Create GitHub token, see documentation: [GH_TOKEN](https://python-semantic-release.readthedocs.io/en/latest/#github-gh-token).
You can then store it in vars.env file like:
```
export GH_TOKEN=github_token_content
```

And before release do: `source vars.env`.

Depends on settings of the repository for protected branches but we have
protected branch which requires PR to push to main branch, hence we use
`--no-push` option.

In my case, the origin (this) repository remote is called `origin` and my fork
is called pbalogh.

Checkout to main branch after merging all PRs you would like to have included
in the release.
`git checkout main`

And **rebase** on latest changes: `git fetch --all && git rebase origin/main`
Or you you can even hard reset: `git reset --hard origin/main`

**Do release**

```shell
$ semantic-release version --patch --no-push
```

This will create new commit and tag for you:
```shell
$ git log

commit ae259e096e27c598ca0787ad090220c21f82b0a4 (tag: v0.0.1, main)
Author: semantic-release <semantic-release>
Date:   Fri Nov 3 11:23:54 2023 +0100

    0.0.1

    Automatically generated by python-semantic-release

$ git tag
v0.0.0
v0.0.1
```

Create branch for release and push cahnges to your fork and create PR out of it:

```shell
$ git checkout -b release-v0.0.1
$ git push pbalogh release-v0.0.1
```
Create PR out of this change.
Get it merged to origin repository and push the tag for the release to origin
repostiory:

```shell
$ git push origin v0.0.1
```


## Creating build and publishing to pypi

Make sure you have set [permission file](https://packaging.python.org/en/latest/specifications/pypirc/) for pypi.
```shell
# Backup previous build

$ mv dist dist-0.0.0

$ python -m build

$ python3 -m twine upload  dist/*
Uploading distributions to https://upload.pypi.org/legacy/
Uploading common_ci_utils-0.0.1-py3-none-any.whl
100% ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 12.8/12.8 kB • 00:00 • ?
Uploading common_ci_utils-0.0.1.tar.gz
100% ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 11.2/11.2 kB • 00:00 • ?

View at:
https://pypi.org/project/common-ci-utils/0.0.1/
```

## TODO: Automate releases via GitHub actions
Add github action [workflow](https://python-semantic-release.readthedocs.io/en/latest/automatic-releases/github-actions.html#example-workflow)

